<div class="app-header">
      <h2 class="header-title">Create Quiz & Add Questions</h2>
    </div>

    <div class="container">
      <mat-card class="mat-elevation-z2">
        <mat-card-title class="app-card-title">Quiz Builder</mat-card-title>
        <mat-card-content>

          <mat-vertical-stepper [linear]="true" #stepper>
            <!-- Step 1: Create Quiz -->
            <mat-step [stepControl]="quizForm" label="Quiz Details">
              <form [formGroup]="quizForm" class="form-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Course ID</mat-label>
                  <input matInput type="number" formControlName="courseID" [ngModel]="courseId" readonly/>
                  <mat-error *ngIf="quizForm.get('courseID')?.hasError('required')">Required</mat-error>
                  <mat-error *ngIf="quizForm.get('courseID')?.hasError('min')">Must be ≥ 1</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Quiz Title</mat-label>
                  <input matInput formControlName="title" maxlength="150"/>
                  <mat-hint align="end">{{ quizForm.get('title')?.value?.length || 0 }}/150</mat-hint>
                  <mat-error *ngIf="quizForm.get('title')?.hasError('required')">Required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Total Marks</mat-label>
                  <input matInput type="number" formControlName="totalMarks" />
                  <mat-error *ngIf="quizForm.get('totalMarks')?.hasError('required')">Required</mat-error>
                  <mat-error *ngIf="quizForm.get('totalMarks')?.hasError('min')">Must be ≥ 1</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Time Limit (minutes)</mat-label>
                  <input matInput type="number" formControlName="timeLimit" />
                  <mat-error *ngIf="quizForm.get('timeLimit')?.hasError('required')">Required</mat-error>
                  <mat-error *ngIf="quizForm.get('timeLimit')?.hasError('min')">Must be ≥ 1</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Attempts Allowed</mat-label>
                  <input matInput type="number" formControlName="attemptsAllowed" />
                  <mat-error *ngIf="quizForm.get('attemptsAllowed')?.hasError('required')">Required</mat-error>
                  <mat-error *ngIf="quizForm.get('attemptsAllowed')?.hasError('min')">Must be ≥ 1</mat-error>
                </mat-form-field>
              </form>

              <div class="actions">
                <button mat-flat-button color="primary" (click)="submitQuiz()" [disabled]="quizForm.invalid || loading()">
                  <mat-icon>save</mat-icon> Create Quiz
                </button>
                <mat-progress-bar *ngIf="loading()" mode="indeterminate" color="accent"></mat-progress-bar>
              </div>

              <div *ngIf="quizId() as qid" class="success-inline">
                <mat-icon color="primary">check_circle</mat-icon>
                Quiz created with ID: <strong>{{ qid }}</strong>
                <button mat-stroked-button color="accent" (click)="stepper.next()" class="ml-8">
                  Next: Add Questions
                </button>
              </div>
            </mat-step>

            <!-- Step 2: Add Questions -->
            <mat-step [stepControl]="questionForm" label="Questions" [editable]="false">
              <form [formGroup]="questionForm" class="form-grid">
                <mat-form-field appearance="outline" class="col-span-2">
                  <mat-label>Question Text</mat-label>
                  <textarea matInput rows="3" formControlName="questionText"></textarea>
                  <mat-error *ngIf="questionForm.get('questionText')?.hasError('required')">Required</mat-error>
                  <mat-error *ngIf="questionForm.get('questionText')?.hasError('minlength')">Min 5 chars</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Question Type</mat-label>
                  <mat-select formControlName="questionType" (selectionChange)="onTypeChange()">
                    <mat-option value="MCQ">MCQ (Single Correct)</mat-option>
                    <mat-option value="TRUE_FALSE">True / False</mat-option>
                    <mat-option value="SHORT_ANSWER">Short Answer</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Marks</mat-label>
                  <input matInput type="number" formControlName="marks"/>
                  <mat-error *ngIf="questionForm.get('marks')?.hasError('required')">Required</mat-error>
                  <mat-error *ngIf="questionForm.get('marks')?.hasError('min')">Must be ≥ 1</mat-error>
                </mat-form-field>

                <!-- Options (for MCQ and TRUE_FALSE) -->
                <div class="col-span-2" *ngIf="showOptions()">
                  <div class="flex space-between">
                    <h4>Options</h4>
                    <button mat-stroked-button color="accent" (click)="addOption()" [disabled]="!canAddOption()">Add Option</button>
                  </div>
                  <div class="options-grid" formArrayName="options">
                    <ng-container *ngFor="let opt of options.controls; let i = index">
                      <mat-form-field appearance="outline">
                        <mat-label>Option {{ i + 1 }}</mat-label>
                        <input matInput [formControlName]="i"/>
                        <button mat-icon-button matSuffix color="warn" aria-label="Remove option"
                                (click)="removeOption(i)" [disabled]="options.controls.length <= minOptionsRequired()">
                          <mat-icon>close</mat-icon>
                        </button>
                      </mat-form-field>
                    </ng-container>
                  </div>
                </div>

                <mat-form-field appearance="outline" class="col-span-2" *ngIf="showCorrectAnswer()">
                  <mat-label>Correct Answer</mat-label>
                  <input matInput formControlName="correctAnswer"/>
                  <mat-hint *ngIf="questionForm.get('questionType')?.value === 'MCQ'">
                    Must match one of the options exactly.
                  </mat-hint>
                  <mat-hint *ngIf="questionForm.get('questionType')?.value === 'TRUE_FALSE'">
                    Must be exactly "True" or "False"
                  </mat-hint>
                  <mat-error *ngIf="questionForm.get('correctAnswer')?.hasError('required')">Required</mat-error>
                </mat-form-field>
              </form>

              <div class="actions">
                <button mat-flat-button color="primary"
                        (click)="submitQuestion()"
                        [disabled]="questionForm.invalid || !quizId() || loading()">
                  <mat-icon>add</mat-icon> Add Question
                </button>
                <button mat-stroked-button color="accent" (click)="resetQuestionForm()" [disabled]="loading()">
                  <mat-icon>refresh</mat-icon> Reset
                </button>
                <mat-progress-bar *ngIf="loading()" mode="indeterminate" color="accent"></mat-progress-bar>
              </div>

              <mat-divider class="my-16"></mat-divider>

              <div *ngIf="createdQuestions().length > 0">
                <h4 class="app-card-title">Created Questions</h4>
                <mat-list>
                  <mat-list-item *ngFor="let q of createdQuestions(); let idx = index">
                    <span matListItemTitle>{{ idx + 1 }}. {{ q.questionText }} ({{ q.questionType }}, {{ q.marks }} marks)</span>
                    <span matListItemLine *ngIf="q.options?.length">Options: {{ q.options.join(', ') }}</span>
                    <span matListItemLine>Answer: {{ q.correctAnswer }}</span>
                  </mat-list-item>
                </mat-list>

                <div class="actions">
                  <button mat-raised-button color="primary" (click)="finish(stepper)">
                    <mat-icon>check_circle</mat-icon> Finish
                  </button>
                </div>
              </div>
            </mat-step>
          </mat-vertical-stepper>

        </mat-card-content>
      </mat-card>
    </div>